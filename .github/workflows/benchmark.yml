name: Performance Benchmarks

on:
  workflow_dispatch:
  schedule:
    - cron: "0 3 * * 1"

jobs:
  benchmark:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    concurrency:
      group: benchmark-${{ github.ref }}
      cancel-in-progress: true

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install --no-audit --no-fund

      - name: Run parser comparison benchmark
        run: npm run bench:compare

      - name: Upload benchmark reports
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-comparison
          path: |
            performance/reports/comparison-latest.md
            performance/reports/comparison-latest.json
          retention-days: 30

      - name: Generate summary
        run: |
          echo "## Benchmark Results (Parser Comparison)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          cat performance/reports/comparison-latest.md >> $GITHUB_STEP_SUMMARY

      - name: Comment PR with results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let summary = '## Benchmark Results (Parser Comparison)\n\n';

            if (fs.existsSync('performance/reports/comparison-latest.md')) {
              summary += fs.readFileSync('performance/reports/comparison-latest.md', 'utf8') + '\n';
            } else {
              summary += '> Benchmark report not found. This may indicate a benchmark execution issue.\n\n';
            }

            summary += '---\n\n';
            summary += '*Generated by GitHub Actions Benchmark Workflow*';

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });
